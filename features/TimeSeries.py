from features.base_feature import BaseFeature
from pathlib import Path
import numpy as np
import pandas as pd
import dask.dataframe as dd
import datetime
from exceptions import IrregularExtractArgumentException
from features.get_dtype import get_csv_dtype


class TimeSeries(BaseFeature):
    """
    [ref]
    """

    def get_loadcols(self):
        cols = [
            "AvSigVersion",
            "OsBuildLab",
            "Census_OSVersion",
            "Census_TotalPhysicalRAM"
        ]
        return cols

    def extract(self):
        return super().extract()

    def timeDiff(self, df):
        """
        OsBuildLab
        AvSigVersion
        """
        def get_datetime(d):
            year = int("20" + d[-11:-9])
            month = int(d[-9:-7])
            day = int(d[-7:-5])
            if (day > 28) & (month == 2):
                day = 28
            elif (day > 30) & (month in [4, 6, 9, 11]):
                day = 30
            elif (day > 31) & (month in [1, 3, 5, 7, 8, 10, 12]):
                day = 31
            return datetime.datetime(year, month, day)

        datedict_avsig = np.load(Path(__file__).absolute().parents[1] / "data" / "external" / "AvSigVersionTimestamps.npy")[()]
        df["AvSigVersion"] = df["AvSigVersion"].map(datedict_avsig).fillna(datetime.datetime(2018, 4, 10))
        df["OsBuildLab"].fillna("17134.1.amd64fre.rs4_release.180410-1804", inplace=True)
        df["OsBuildLab"] = df["OsBuildLab"].apply(get_datetime)

        df["diff"] = (df["AvSigVersion"] - df["OsBuildLab"]).dt.days.astype(int)
        return df[["MachineIdentifier", "diff"]]

    def Diff_by_mem(self, df):
        """
        OsBuildLab
        AvSigVersion
        Census_TotalPhysicalRAM
        """
        def get_datetime(d):
            year = int("20" + d[-11:-9])
            month = int(d[-9:-7])
            day = int(d[-7:-5])
            if (day > 28) & (month == 2):
                day = 28
            elif (day > 30) & (month in [4, 6, 9, 11]):
                day = 30
            elif (day > 31) & (month in [1, 3, 5, 7, 8, 10, 12]):
                day = 31
            return datetime.datetime(year, month, day)

        datedict_avsig = np.load(Path(__file__).absolute().parents[1] / "data" / "external" / "AvSigVersionTimestamps.npy")[()]
        df["AvSigVersion"] = df["AvSigVersion"].map(datedict_avsig).fillna(datetime.datetime(2018, 4, 10))
        df["OsBuildLab"].fillna("17134.1.amd64fre.rs4_release.180410-1804", inplace=True)
        df["OsBuildLab"] = df["OsBuildLab"].apply(get_datetime)

        df["diff"] = (df["AvSigVersion"] - df["OsBuildLab"]).dt.days.astype(int)
        df["diff_by_mem"] = df["diff"] * df["Census_TotalPhysicalRAM"]
        return df[["MachineIdentifier", "diff_by_mem"]]
