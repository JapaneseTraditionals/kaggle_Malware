from features.base_feature import BaseFeature
from pathlib import Path
import numpy as np
import pandas as pd
import dask.dataframe as dd
import datetime
from exceptions import IrregularExtractArgumentException
from features.get_dtype import get_csv_dtype


class TimeSeries(BaseFeature):
    """
    [ref]
    """

    def get_loadcols(self):
        cols = [
            "AvSigVersion",
            "OsBuildLab",
            "Census_OSVersion"
        ]
        return cols

    def extract(self):
        return super().extract()

    def timeDiff(self, df):
        """
        OsBuildLab

        OsBuildLab から AvSigVersion
        """
        def get_datetime(d):
            year = int("20" + d[-11:-9])
            month = int(d[-9:-7])
            day = int(d[-7:-5])
            if (day > 28) & (month == 2):
                day = 28
            elif (day > 30) & (month in [4, 6, 9, 11]):
                day = 30
            elif (day > 31) & (month in [1, 3, 5, 7, 8, 10, 12]):
                day = 31
            return datetime.datetime(year, month, day)

        full_df = self.load_full()
        datedict_avsig = np.load(Path(__file__).absolute().parents[1] / "data" / "external" / "AvSigVersionTimestamps.npy")[()]
        full_df["AvSigVersion"] = full_df["AvSigVersion"].map(datedict_avsig).fillna(datetime.datetime(2018, 4, 10))
        full_df["OsBuildLab"].fillna("17134.1.amd64fre.rs4_release.180410-1804", inplace=True)
        full_df["OsBuildLab"] = full_df["OsBuildLab"].apply(get_datetime)

        full_df["diff"] = (full_df["AvSigVersion"] - full_df["OsBuildLab"]).dt.days.astype(int)

        M_id = df["MachineIdentifier"].values.tolist()
        back_df = full_df[full_df["MachineIdentifier"].isin(M_id)]

        return back_df[["MachineIdentifier", "diff"]]
