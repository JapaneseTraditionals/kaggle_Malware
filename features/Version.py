from features.base_feature import BaseFeature


class Version(BaseFeature):
    """
    https://github.com/icebee16/Malware/blob/master/notebook/eda/EngineVersion_AppVersion_AvSigVersion_EDA.ipynb
    """

    def get_loadcols(self):
        cols = [
            "EngineVersion",
            "AppVersion",
            "AvSigVersion"
        ]
        return cols

    def extract(self):
        return super().extract()

    def popularEngine2(self, df):
        """
        EngineVersion
        """
        ratio = 0.1

        df["EngineVersion"] = df["EngineVersion"].str.split(".", expand=True)[2]

        vc = df["EngineVersion"].value_counts()
        vc_list = vc[vc > ratio * len(df)].index.tolist()

        df = df.assign(cls=0)
        df.loc[df["EngineVersion"].isin(vc_list), "cls"] = 1

        return df[["MachineIdentifier", "cls"]]

    def App1_is_18(self, df):
        """
        AppVersion
        """
        df["AppVersion"] = df["AppVersion"].str.split(".", expand=True)[1]
        df["AppVersion"] = (df["AppVersion"] == "18")
        return df[["MachineIdentifier", "AppVersion"]]

    def clfApp2(self, df):
        """
        AppVersion
        """
        df["AppVersion"] = df["AppVersion"].str.split(".", expand=True)[2]
        df["AppVersion"] = (df["AppVersion"].astype(float) > 10000)
        return df[["MachineIdentifier", "AppVersion"]]

    def popularAvSig1(self, df):
        """
        AvSigVersion
        """
        ratio = 0.1

        df["AvSigVersion"] = df["AvSigVersion"].str.replace(r"1.2&#x17;3.1144.0", r"1.273.1144.0")
        df["AvSigVersion"] = df["AvSigVersion"].str.split(".", expand=True)[1]

        vc = df["AvSigVersion"].value_counts()
        vc_list = vc[vc > ratio * len(df)].index.tolist()

        df = df.assign(cls=0)
        df.loc[df["AvSigVersion"].isin(vc_list), "cls"] = 1

        return df[["MachineIdentifier", "cls"]]

    def Eng2_mul_App1(self, df):
        """
        AvSigVersion
        EngineVersion
        """
        ratio = 0.1

        df["EngineVersion"] = df["EngineVersion"].str.split(".", expand=True)[2]
        df["AppVersion"] = df["AppVersion"].str.split(".", expand=True)[1]
        df["Eng2_mul_App1"] = df["EngineVersion"].astype(int) * df["AppVersion"].astype(int)

        vc = df["Eng2_mul_App1"].value_counts()
        vc_list = vc[vc > ratio * len(df)].index.tolist()

        df = df.assign(cls=0)
        df.loc[df["Eng2_mul_App1"].isin(vc_list), "cls"] = 1

        return df[["MachineIdentifier", "cls"]]
