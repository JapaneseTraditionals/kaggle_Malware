from features.base_feature import BaseFeature


class Os(BaseFeature):

    def get_loadcols(self):
        cols = [
            "Platform",
            "OsVer",
            "OsBuild",
            "OsPlatformSubRelease",
            "OsBuildLab",
            "Census_OSVersion",
            "Census_OSArchitecture",
            "Census_OSBranch",
            "Census_OSBuildNumber",
            "Census_OSBuildRevision"
        ]
        return cols

    def extract(self):
        return super().extract()

    def isServer(self, df):
        df["isServer"] = (df["Platform"] == "windows2016")
        return df[["MachineIdentifier", "isServer"]]

    # Census_OSVersion
    def COSOsVer(self, df):
        df["Census_OSVersion"] = df["Census_OSVersion"].str.apply(lambda s: int(s.split(".")[0] + "." + s.split(".")[1]))
        return df[["MachineIdentifier", "Census_OSVersion"]]

    def COSBuildNumber(self, df):
        df["Census_OSVersion"] = df["Census_OSVersion"].str.apply(lambda s: int(s.split(".")[2]))
        return df[["MachineIdentifier", "Census_OSVersion"]]

    def COSBuildRevision(self, df):
        df["Census_OSVersion"] = df["Census_OSVersion"].str.apply(lambda s: int(s.split(".")[3]))
        return df[["MachineIdentifier", "Census_OSVersion"]]

    # OsBuildLab
    def __OSBuildLab_spliter(self, df):
        col = ["OBL_{}".format(s) for s in ["OsBuild", "OsBuildRevision", "OsArchitecture", "OsBranch", "BuildDate"]]
        temp = df["OsBuildLab"].str.replace(r"*", r".").str.split(".", expand=True)
        temp.columns = col
        for c in col:
            df[c] = temp[c]

        # for Nan values
        full_df = self.load_full()
        full_df = full_df.set_index("MachineIdentifier")
        null_df = df[df["OsBuildLab"].isnull()]
        temp = df.set_index("MachineIdentifier")
        for m_id in null_df["MachineIdentifier"].values.tolist():
            temp.loc[m_id, "OBL_OsBuild"] = full_df.loc[m_id, "OsBuild"]
            temp.loc[m_id, "OBL_OsBuildRevision"] = full_df.loc[m_id, "Census_OSBuildRevision"]
            temp.loc[m_id, "OBL_OsBranch"] = full_df.loc[m_id, "Census_OSBranch"]
            temp.loc[m_id, "OBL_BuildDate"] = temp["OBL_BuildDate"].mode()[0]
        temp = temp.reset_index()
        df[col] = temp[col]
        df = df.astype({col[0]: "int16", col[1]: "int16", col[2]: "str", col[3]: "str", col[4]: "str"})
        return df

    def OSBuildNumber(self, df):
        df["OsBuildLab"] = df["OsBuildLab"].fillna("17134.1.amd64fre.rs4_release.180410-1804").str.replace(r"*", r".")
        df["OsBuildLab"] = df["OsBuildLab"].apply(lambda s: int(s.split(".")[0]))
        return df[["MachineIdentifier", "OsBuildLab"]]

    def OSBuildRevision(self, df):
        df["OsBuildLab"] = df["OsBuildLab"].fillna("17134.1.amd64fre.rs4_release.180410-1804").str.replace(r"*", r".")
        df["OsBuildLab"] = df["OsBuildLab"].apply(lambda s: int(s.split(".")[1]))
        return df[["MachineIdentifier", "OsBuildLab"]]

    def OSArchitecture(self, df):  # Category
        df["OsBuildLab"] = df["OsBuildLab"].fillna("17134.1.amd64fre.rs4_release.180410-1804").str.replace(r"*", r".")
        df["OsBuildLab"] = df["OsBuildLab"].apply(lambda s: int(s.split(".")[2]))
        return df[["MachineIdentifier", "OsBuildLab"]]

    def OSBranch(self, df):  # Category
        df["OsBuildLab"] = df["OsBuildLab"].fillna("17134.1.amd64fre.rs4_release.180410-1804").str.replace(r"*", r".")
        df["OsBuildLab"] = df["OsBuildLab"].apply(lambda s: int(s.split(".")[3]))
        return df[["MachineIdentifier", "OsBuildLab"]]

    def OSBuildDate(self, df):
        df["OsBuildLab"] = df["OsBuildLab"].fillna("17134.1.amd64fre.rs4_release.180410-1804").str.replace(r"*", r".")
        df["OsBuildLab"] = df["OsBuildLab"].apply(lambda s: int(s.split(".")[4]))
        df["OsBuildLab"] = df["OsBuildLab"].apply(lambda s: int(s.split("-")[0] + s.split("-")[1]))
        return df[["MachineIdentifier", "OsBuildLab"]]

    def OSBuildDate_Year(self, df):
        df["OsBuildLab"] = df["OsBuildLab"].fillna("17134.1.amd64fre.rs4_release.180410-1804").str.replace(r"*", r".")
        df["OsBuildLab"] = df["OsBuildLab"].apply(lambda s: int(s.split(".")[4][:2]))
        return df[["MachineIdentifier", "OsBuildLab"]]

    def OSBuildDate_Month(self, df):
        df["OsBuildLab"] = df["OsBuildLab"].fillna("17134.1.amd64fre.rs4_release.180410-1804").str.replace(r"*", r".")
        df["OsBuildLab"] = df["OsBuildLab"].apply(lambda s: int(s.split(".")[4][2:4]))
        return df[["MachineIdentifier", "OsBuildLab"]]
