from features.base_feature import BaseFeature


class Revision(BaseFeature):

    def get_loadcols(self):
        cols = [
            "OsBuildLab"
        ]
        return cols

    def extract(self):
        return super().extract()

    def clfCountRevision(self, df):
        """
        OsBuildLab
        https://github.com/icebee16/Malware/blob/master/notebook/eda/Census_OSBuildRevisionEDA.ipynb
        """
        ratio = 0.0028  # 25000 / 8921483

        df["OsBuildLab"] = df["OsBuildLab"].fillna("17134.1.amd64fre.rs4_release.180410-1804").str.replace(r"*", r".")
        df["OsBuildLab_Revision"] = df["OsBuildLab"].str.split(".", expand=True)[1].astype(int)

        vc = df["OsBuildLab_Revision"].value_counts()
        vc_list = vc[vc > ratio * len(df)].index.tolist()

        df = df.assign(cls=0)
        df.loc[df["OsBuildLab_Revision"].isin(vc_list) & (df["OsBuildLab_Revision"] < 650), "cls"] = 1
        df.loc[df["OsBuildLab_Revision"].isin(vc_list) & (df["OsBuildLab_Revision"] >= 650), "cls"] = 2

        return df[["MachineIdentifier", "cls"]]
