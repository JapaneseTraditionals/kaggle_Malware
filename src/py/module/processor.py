from pathlib import Path
from module.feature_extractor import FeatureExtractor
from module.import_libs import *
from module.malware_classifier import MalwareClassifier
from module.save_log import stop_watch

ROOT_PATH = Path(__file__).absolute().parents[3]


class Processor():
    """
    For processing train and test
    """
    def __init__(self, args, feature_map, lgbm_params,
                 input_path=ROOT_PATH / "input",
                 feature_type="default"):
        """
        Parameters
        args: args from main (src/py/[index].py)
        feature_map: feature_map from main
        lgbm_params: feature_map from main
        [optional] input_path: file path of input files.
        You'd better use this parameter when you want to split datasets.
        [optional] feature_type: type_name of features.
        This should be used when you want to change the definition of groups.
        """
        self.args = args
        self.feature_extractor = FeatureExtractor(feature_map,
                                                  input_path, feature_type)
        self.malware_classifier = MalwareClassifier(lgbm_params)

    @stop_watch("Processor/process_train()")
    def __process_train(self):
        """
        Processing of train
        1. Feature Extraction
        2. Fitting train data with lgbm
        ---
        Return
        validity: validation output of this process
        clf: classifier obtained by lgbm
        """
        df = self.feature_extractor.extract(is_train=True)
        clf = self.malware_classifier.fit(df)
        validity = 0
        return validity, clf

    @stop_watch("Processor/process_test()")
    def __process_test(self, clf):
        """
        Processing of test
        1. Feature Extraction
        2. Predict test data with classifier obtained from process_train()
        ---
        Parameters
        clf: classifier obtained by lgbm
        """
        df = self.feature_extractor.extract(is_train=False)
        submit = self.malware_classifier.predict(df, clf)
        return submit

    def process(self):
        """
        For processing train and test
        """
        validity, clf = self.__process_train()
        predict = None
        if not self.args.dontPredict:
            predict = self.__process_test(clf)
        return validity, predict
